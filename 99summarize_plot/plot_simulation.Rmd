---
title: "simulation_plot"
author: "Changyi"
date: "2026-01-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#library packages
```{r}
library(data.table)
library(ggplot2)
library(ggsignif)
library(corrplot)
library(factoextra)
library(ggpubr)
library(ggforce)
```

#functions
##function for pca_plot
```{r}
pca_plot<-function(dir=NULL,run=NULL,popsize=NULL,num_sample=NULL,num_target=NULL,strength=NULL, plot_title=NULL){
  file_idx = paste0("../",dir,"/02pca/pca_result/Run",run,"_popsize",popsize,"_n",num_sample,"_",num_target,"loci_s",strength,".pca")
  #print(file_idx)
  sc=strength/num_target
  if (is.null(plot_title)){plot_title=paste0(num_target,"loci_s",strength,"(sc=",sc,")")}
  pca.res=readRDS(paste0(file_idx,".res.rds"))
  pca.var=readRDS(paste0(file_idx,".var.rds"))
  samples=rownames(pca.res)
  splits<-unlist(strsplit(samples,'_'))
  generations=as.factor(splits[grep("F",splits)])
  replicates=as.factor(splits[grep("rep",splits)])
  groups=as.factor(splits[grep("^p",splits)])
  rep_gen=as.factor(paste(replicates, generations,sep="_"))
  #plot_pop_gen
  col_evo=colorRampPalette(c("#E7726F","#FBEC92","#79BC81"))(8)
  p<-ggplot(as.data.frame(pca.res), aes(x=PC1, y=PC2, col=generations, shape=groups))+
    geom_point()+
    scale_color_manual(values = c("black",col_evo))+
    labs(x=paste("PC1(",round(pca.var[1],2),"%)",sep=""),
         y=paste("PC2(",round(pca.var[2],2),"%)",sep=""))+
    labs(title=plot_title)
  return(p)
}


```

##function for AFC_cor plot
```{r}
afc_cor_plot <-function(dt_afc_cor, run=NULL, popsize=NULL, num_sample=NULL, num_target=NULL, strength=NULL, ymin = -0.1, ymax = 1.0, plot_title = NULL){
  plot_data <- dt_afc_cor[
    Run == run &
    Popsize == popsize &
    Num_sample == num_sample &
    Num_target == num_target &
    Strength == strength
  ]
  p_afc_cor <- ggplot(plot_data, aes(x=gen, y=r, fill=comparison))+
        geom_boxplot()+
        ylim(ymin,ymax)+
        #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
        labs(title=plot_title, x = "Generation", y = "AFC correlation")
  return(p_afc_cor)
}


```

#generate folder structure
```{bash}
for sim in SimulationA SimulationB SimulationC
do
  mkdir -p "${sim}/by_regime" "${sim}/by_run"
done
```


#1. simulationA_LD
##initialize parameters
```{r}
##parameters that are constant across this section
workdir <- "02slim_simulationA_LD_sampling"
simulation <- "SimulationA"
linkage <- "LD"
para_num_sample <- 400 
```



##1.1 PCA
```{r}
#organize by run
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10,50,100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength)
      i <- i + 1
    }
  }
  plots[[19]] <- pca_plot(dir = workdir, run = para_run, popsize = 300, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Drift300"))
  plots[[20]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Drift1250"))
  p_merge<-ggarrange(plotlist = plots, ncol = 6, nrow = 4, common.legend = T)
  p_merge<- annotate_figure(p_merge, fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_PCA"), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")

  ggsave(filename = paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_PCA.pdf"), plot = p_merge, width = 18, height = 12)
}
  

#organize plot by selection regime
#drift
for(para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
    plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = para_popsize, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Run",para_run))
    i=i+1
    }
  p_merge<-ggarrange(plotlist = plots, ncol = 5, nrow = 2, common.legend = T)
  p_merge<- annotate_figure(p_merge, fig.lab = paste0(simulation,"_",linkage,"_Drift_popsize",para_popsize), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(filename = paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_PCA.pdf"), plot = p_merge, width = 20, height = 9)
}

for (para_num_target in c(10,100,1000,5000,10000,20000)){
  for (para_strength in c(10,50,100)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength,plot_title = paste0("Run",para_run))
      i=i+1
    }
    p_merge<-ggarrange(plotlist = plots, ncol = 5, nrow = 2, common.legend = T)
    p_merge<- annotate_figure(p_merge, 
                              fig.lab = paste0(simulation,"_",linkage,"_",para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")_PCA"), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_PCA.pdf"), plot = p_merge, width = 20, height = 9)
  }
}

rm(p_merge, plots)
```

##1.2 AFC correlation_allSNPs
```{r}
#load AFC correlation
afc_cor<-NULL
##drift
para_num_target=10 #there's no selection target under neutral simulation, just to match the name
para_strength=0
for (para_popsize in c(300,1250)){
  for (para_run in seq(1,10)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_allSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample
    temp_f$Num_target <- para_num_target
    temp_f$Strength<- para_strength
    afc_cor<-rbind(afc_cor,temp_f)
  }
}

##selection
para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    for (para_strength in c(10,50,100)){
      temp_f<-fread(paste0("../",workdir,
                           "/03afc_cor/results_allSNPs/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,"_",
                           para_num_target,"loci_s",para_strength,
                           "_cor.txt.gz"))
      temp_f$Run <- para_run
      temp_f$Popsize <- para_popsize
      temp_f$Num_sample <- para_num_sample
      temp_f$Num_target <- para_num_target
      temp_f$Strength <- para_strength
      afc_cor<-rbind(afc_cor,temp_f)
    }
  }
}
      
afc_cor$gen<-factor(afc_cor$gen)

#plot
##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10, 50, 100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 plot_title = paste0(para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")"))
      i <- i + 1
    }
  }
  plots[[19]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = 300, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = "Drift300")
  plots[[20]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = 1250, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = "Drift1250")
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_allSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 18, height = 13)
}



##organize by selection regime
###drift
for (para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
  
  }
  combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_Drift",para_popsize,"_AFC_cor_allSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}
###selection
para_popsize <- 1250
for (para_strength in c(10,50, 100)){
  for (para_num_target in c(10, 100, 1000,5000,10000,20000)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
    }
    combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_", para_num_target, "loci_s",para_strength, "(sc = ", para_strength/para_num_target, ")_AFC_cor_allSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
  }
}


```


##1.3 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor <- afc_cor[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_strength in c(10,50,100)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    para_popsize <- 1250
    dt_plot <- summary_median_afc_cor[
      Popsize == para_popsize &
      Num_sample == para_num_sample &
      Num_target == para_num_target &
      Strength == para_strength
      ]
    plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
      geom_boxplot()+
      ylim(-0.1,1)+
      #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
    labs(title=paste0(para_num_target,"loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")"),
         x = "Generation", y = "AFC correlation")
    i=i+1
  }
}
dt_plot <- summary_median_afc_cor[
      Popsize == 300 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[19]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.01,0.01)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
  labs(title="Drift300", x = "Generation", y = "AFC correlation")


dt_plot <- summary_median_afc_cor[
      Popsize == 1250 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[20]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.01,0.01)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
   labs(title="Drift1250", x = "Generation", y = "AFC correlation")

combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_allSNPs.pdf"),plot = combine_plot, width = 18, height = 13)
rm(afc_cor)
rm(summary_median_afc_cor)
```


##1.4 AFC correlation_PC1_sigSNPs
```{r}
#load AFC correlation
afc_cor_sig<-NULL
##drift
para_num_target=10 #there's no selection target under neutral simulation, just to match the name
para_strength=0
for (para_popsize in c(300,1250)){
  for (para_run in seq(1,10)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_PC1_sigSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample
    temp_f$Num_target <- para_num_target
    temp_f$Strength<- para_strength
    afc_cor_sig<-rbind(afc_cor_sig,temp_f)
  }
}

##selection
para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    for (para_strength in c(10,50,100)){
      temp_f<-fread(paste0("../",workdir,
                           "/03afc_cor/results_PC1_sigSNPs/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,"_",
                           para_num_target,"loci_s",para_strength,
                           "_cor.txt.gz"))
      temp_f$Run <- para_run
      temp_f$Popsize <- para_popsize
      temp_f$Num_sample <- para_num_sample
      temp_f$Num_target <- para_num_target
      temp_f$Strength <- para_strength
      afc_cor_sig<-rbind(afc_cor_sig,temp_f)
    }
  }
}
      
afc_cor_sig$gen<-factor(afc_cor_sig$gen)

#plot

##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10, 50, 100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength,
                                 ymin = -0.6, ymax = 1.0,
                                 plot_title = paste0(para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")"))
      i <- i + 1
    }
  }
  plots[[19]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = 300, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.4, ymax = 0.4,
                                 plot_title = "Drift300")
  plots[[20]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = 1250, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.4, ymax = 0.4,
                                 plot_title = "Drift1250")
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 18, height = 13)
}



##organize by selection regime
###drift
for (para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.4, ymax = 0.4,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
  
  }
  combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_Drift",para_popsize,"_AFC_cor_PC1_sigSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}
###selection
para_popsize <- 1250
for (para_strength in c(10,50, 100)){
  for (para_num_target in c(10, 100, 1000,5000,10000,20000)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 ymin = -0.6, ymax = 1.0,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
    }
    combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_", para_num_target, "loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")_AFC_cor_PC1_sigSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
  }
}


```

##1.5 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor_sig <- afc_cor_sig[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_strength in c(10,50,100)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    para_popsize <- 1250
    dt_plot <- summary_median_afc_cor_sig[
      Popsize == para_popsize &
      Num_sample == para_num_sample &
      Num_target == para_num_target &
      Strength == para_strength
      ]
    plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
      geom_boxplot()+
      ylim(-0.4,1)+
      #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
    labs(title=paste0(para_num_target,"loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")"),
         x = "Generation", y = "AFC correlation")
    i=i+1
  }
}
dt_plot <- summary_median_afc_cor_sig[
      Popsize == 300 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[19]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.2,0.2)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
  labs(title="Drift300", x = "Generation", y = "AFC correlation")


dt_plot <- summary_median_afc_cor_sig[
      Popsize == 1250 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[20]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.2,0.2)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
   labs(title="Drift1250", x = "Generation", y = "AFC correlation")

combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_PC1_sigSNPs.pdf"),plot = combine_plot, width = 18, height = 13)
rm(afc_cor_sig)
rm(summary_median_afc_cor_sig)
```

##1.6 Effective population size(Ne)
```{r}

dt_ne <- data.table()
#load data
##drift
for (para_run in seq(1,10)){
  for (para_popsize in c(300,1250)){
    for (para_num_sample in c(400)){
      for (para_num_target in c(10)){
        for (para_strength in c(0)){
          f_name <- paste0("../",workdir, "/04estimate_Ne/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,
                           "_",para_num_target,"loci_s",para_strength,
                           ".ne")
          temp_ne <- fread(f_name)
          temp_ne[, c("run", "popsize", "num_sample", "num_target", "strength") := 
                    lapply(
                      tstrsplit(treatment, split = "_", fill = NA), 
                      factor)]
          temp_ne[, num_target := paste0("Drift", para_popsize)]
          temp_ne[, strength := "Neutral"]
          dt_ne <- rbind(dt_ne, temp_ne)
        }
      }
    }
  }
}
##selection
for (para_run in seq(1,10)){
  for (para_popsize in c(1250)){
    for (para_num_sample in c(400)){
      for (para_num_target in c(10, 100, 1000, 5000, 10000, 20000)){
        for (para_strength in c(10, 50, 100)){
      f_name <- paste0("../",workdir, "/04estimate_Ne/Run",para_run,
                       "_popsize",para_popsize,
                       "_n",para_num_sample,
                       "_",para_num_target,"loci_s",para_strength,
                       ".ne")
      temp_ne <- fread(f_name)
      temp_ne[, c("run", "popsize", "num_sample", "num_target", "strength") := 
                lapply(
                  tstrsplit(treatment, split = "_", fill = NA),
                  factor)]
      dt_ne <- rbind(dt_ne, temp_ne)
        }
      }
    }
  }
}

dt_ne[, num_target := factor(num_target, levels = c("Drift300","Drift1250",
                                                    "10loci", "100loci", "1000loci", "5000loci", "10000loci", "20000loci"))]
#plot
plots <- list()
i <- 1
for (para_run in seq(1,10)){
  plots[[i]] <- ggplot(subset(dt_ne, run==paste0("Run", para_run)), aes(x=num_target, y = Ne, fill = strength))+
    geom_boxplot()+
    geom_hline(yintercept = 311, linetype = "dashed")+
    scale_fill_manual(values = c("white","#D4EEFC","#FAECAF","#ECC4B5"))+
    facet_grid(~strength, scale = "free_x", space = "free_x")+
    labs(x="Number of Selection Targets", y="Effective Population Size (Ne)", title = paste0("Run",para_run))+
    theme(legend.position = "none",
          axis.text.x = element_text(angle = -60, vjust = 0.5, hjust = 0))
  i <- i + 1
}

merge_p <- ggarrange(plotlist = plots,
                     nrow=2, ncol = 5)
merge_p<-annotate_figure(
    merge_p,
    top = text_grob(
      paste0(simulation,"_",linkage,"_Ne"),
      color = "black", face = "bold", size = 20,
      x = 0, hjust = 0
    )
)
    #fig.lab = paste0(simulation,"_",linkage,"_Ne"), 
    #fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_Ne.pdf"), plot = merge_p, width = 30, height = 13)
rm(dt_ne)
```


#2. simulationA_LE
##initialize parameters
```{r}
##parameters that are constant across this section
workdir <- "03slim_simulationA_LE_sampling"
simulation <- "SimulationA"
linkage <- "LE"
para_num_sample <- 400 
```



##2.1 PCA
```{r}
#organize by run
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10,50,100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength)
      i <- i + 1
    }
  }
  plots[[19]] <- pca_plot(dir = workdir, run = para_run, popsize = 300, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Drift300"))
  plots[[20]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Drift1250"))
  p_merge<-ggarrange(plotlist = plots, ncol = 6, nrow = 4, common.legend = T)
  p_merge<- annotate_figure(p_merge, fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_PCA"), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")

  ggsave(filename = paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_PCA.pdf"), plot = p_merge, width = 18, height = 12)
}
  

#organize plot by selection regime
#drift
for(para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
    plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = para_popsize, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Run",para_run))
    i=i+1
    }
  p_merge<-ggarrange(plotlist = plots, ncol = 5, nrow = 2, common.legend = T)
  p_merge<- annotate_figure(p_merge, fig.lab = paste0(simulation,"_",linkage,"_Drift_popsize",para_popsize), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(filename = paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_PCA.pdf"), plot = p_merge, width = 20, height = 9)
}

for (para_num_target in c(10,100,1000,5000,10000,20000)){
  for (para_strength in c(10,50,100)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength,plot_title = paste0("Run",para_run))
      i=i+1
    }
    p_merge<-ggarrange(plotlist = plots, ncol = 5, nrow = 2, common.legend = T)
    p_merge<- annotate_figure(p_merge, 
                              fig.lab = paste0(simulation,"_",linkage,"_",para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")_PCA"), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_PCA.pdf"), plot = p_merge, width = 20, height = 9)
  }
}
rm(p_merge, plots)
```

##2.2 AFC correlation_allSNPs
```{r}
#load AFC correlation
afc_cor<-NULL
##drift
para_num_target=10 #there's no selection target under neutral simulation, just to match the name
para_strength=0
for (para_popsize in c(300,1250)){
  for (para_run in seq(1,10)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_allSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample
    temp_f$Num_target <- para_num_target
    temp_f$Strength<- para_strength
    afc_cor<-rbind(afc_cor,temp_f)
  }
}

##selection
para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    for (para_strength in c(10,50,100)){
      temp_f<-fread(paste0("../",workdir,
                           "/03afc_cor/results_allSNPs/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,"_",
                           para_num_target,"loci_s",para_strength,
                           "_cor.txt.gz"))
      temp_f$Run <- para_run
      temp_f$Popsize <- para_popsize
      temp_f$Num_sample <- para_num_sample
      temp_f$Num_target <- para_num_target
      temp_f$Strength <- para_strength
      afc_cor<-rbind(afc_cor,temp_f)
    }
  }
}
      
afc_cor$gen<-factor(afc_cor$gen)

#plot
##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10, 50, 100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 plot_title = paste0(para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")"))
      i <- i + 1
    }
  }
  plots[[19]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = 300, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = "Drift300")
  plots[[20]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = 1250, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = "Drift1250")
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_allSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 18, height = 13)
}



##organize by selection regime
###drift
for (para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
  
  }
  combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_Drift",para_popsize,"_AFC_cor_allSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}
###selection
para_popsize <- 1250
for (para_strength in c(10,50, 100)){
  for (para_num_target in c(10, 100, 1000,5000,10000,20000)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
    }
    combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_", para_num_target, "loci_s",para_strength, "(sc = ", para_strength/para_num_target, ")_AFC_cor_allSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
  }
}


```


##2.3 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor <- afc_cor[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_strength in c(10,50,100)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    para_popsize <- 1250
    dt_plot <- summary_median_afc_cor[
      Popsize == para_popsize &
      Num_sample == para_num_sample &
      Num_target == para_num_target &
      Strength == para_strength
      ]
    plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
      geom_boxplot()+
      ylim(-0.1,1)+
      #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
    labs(title=paste0(para_num_target,"loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")"),
         x = "Generation", y = "AFC correlation")
    i=i+1
  }
}
dt_plot <- summary_median_afc_cor[
      Popsize == 300 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[19]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.01,0.01)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
  labs(title="Drift300", x = "Generation", y = "AFC correlation")


dt_plot <- summary_median_afc_cor[
      Popsize == 1250 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[20]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.01,0.01)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
   labs(title="Drift1250", x = "Generation", y = "AFC correlation")

combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_allSNPs.pdf"),plot = combine_plot, width = 18, height = 13)
rm(afc_cor)
rm(summary_median_afc_cor)
```


##2.4 AFC correlation_PC1_sigSNPs
```{r}
#load AFC correlation
afc_cor_sig<-NULL
##drift
para_num_target=10 #there's no selection target under neutral simulation, just to match the name
para_strength=0
for (para_popsize in c(300,1250)){
  for (para_run in seq(1,10)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_PC1_sigSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample
    temp_f$Num_target <- para_num_target
    temp_f$Strength<- para_strength
    afc_cor_sig<-rbind(afc_cor_sig,temp_f)
  }
}

##selection
para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    for (para_strength in c(10,50,100)){
      temp_f<-fread(paste0("../",workdir,
                           "/03afc_cor/results_PC1_sigSNPs/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,"_",
                           para_num_target,"loci_s",para_strength,
                           "_cor.txt.gz"))
      temp_f$Run <- para_run
      temp_f$Popsize <- para_popsize
      temp_f$Num_sample <- para_num_sample
      temp_f$Num_target <- para_num_target
      temp_f$Strength <- para_strength
      afc_cor_sig<-rbind(afc_cor_sig,temp_f)
    }
  }
}
      
afc_cor_sig$gen<-factor(afc_cor_sig$gen)

#plot

##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10, 50, 100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength,
                                 ymin = -0.6, ymax = 1.0,
                                 plot_title = paste0(para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")"))
      i <- i + 1
    }
  }
  plots[[19]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = 300, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.4, ymax = 0.4,
                                 plot_title = "Drift300")
  plots[[20]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = 1250, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.4, ymax = 0.4,
                                 plot_title = "Drift1250")
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 18, height = 13)
}



##organize by selection regime
###drift
for (para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.4, ymax = 0.4,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
  
  }
  combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_Drift",para_popsize,"_AFC_cor_PC1_sigSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}
###selection
para_popsize <- 1250
for (para_strength in c(10,50, 100)){
  for (para_num_target in c(10, 100, 1000,5000,10000,20000)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
    }
    combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_", para_num_target, "loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")_AFC_cor_PC1_sigSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
  }
}


```

##2.5 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor_sig <- afc_cor_sig[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_strength in c(10,50,100)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    para_popsize <- 1250
    dt_plot <- summary_median_afc_cor_sig[
      Popsize == para_popsize &
      Num_sample == para_num_sample &
      Num_target == para_num_target &
      Strength == para_strength
      ]
    plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
      geom_boxplot()+
      ylim(-0.4,1)+
      #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
    labs(title=paste0(para_num_target,"loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")"),
         x = "Generation", y = "AFC correlation")
    i=i+1
  }
}
dt_plot <- summary_median_afc_cor_sig[
      Popsize == 300 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[19]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.2,0.25)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test", label = "p.signif", hide.ns = TRUE)+
  labs(title="Drift300", x = "Generation", y = "AFC correlation")


dt_plot <- summary_median_afc_cor_sig[
      Popsize == 1250 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[20]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.2,0.25)+
    #stat_compare_means(aes(group=comparison), method = "wilcox.test", label = "p.signif", hide.ns = TRUE)+
   labs(title="Drift1250", x = "Generation", y = "AFC correlation")

combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_PC1_sigSNPs.pdf"),plot = combine_plot, width = 18, height = 13)
rm(afc_cor_sig)
rm(summary_median_afc_cor_sig)
```

##2.6 Effective population size(Ne)
```{r}

dt_ne <- data.table()
#load data
##drift
for (para_run in seq(1,10)){
  for (para_popsize in c(300,1250)){
    for (para_num_sample in c(400)){
      for (para_num_target in c(10)){
        for (para_strength in c(0)){
          f_name <- paste0("../",workdir, "/04estimate_Ne/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,
                           "_",para_num_target,"loci_s",para_strength,
                           ".ne")
          temp_ne <- fread(f_name)
          temp_ne[, c("run", "popsize", "num_sample", "num_target", "strength") := 
                    lapply(
                      tstrsplit(treatment, split = "_", fill = NA), 
                      factor)]
          temp_ne[, num_target := paste0("Drift", para_popsize)]
          temp_ne[, strength := "Neutral"]
          dt_ne <- rbind(dt_ne, temp_ne)
        }
      }
    }
  }
}
##selection
for (para_run in seq(1,10)){
  for (para_popsize in c(1250)){
    for (para_num_sample in c(400)){
      for (para_num_target in c(10, 100, 1000, 5000, 10000, 20000)){
        for (para_strength in c(10, 50, 100)){
      f_name <- paste0("../",workdir, "/04estimate_Ne/Run",para_run,
                       "_popsize",para_popsize,
                       "_n",para_num_sample,
                       "_",para_num_target,"loci_s",para_strength,
                       ".ne")
      temp_ne <- fread(f_name)
      temp_ne[, c("run", "popsize", "num_sample", "num_target", "strength") := 
                lapply(
                  tstrsplit(treatment, split = "_", fill = NA),
                  factor)]
      dt_ne <- rbind(dt_ne, temp_ne)
        }
      }
    }
  }
}

dt_ne[, num_target := factor(num_target, levels = c("Drift300","Drift1250",
                                                    "10loci", "100loci", "1000loci", "5000loci", "10000loci", "20000loci"))]
#plot
plots <- list()
i <- 1
for (para_run in seq(1,10)){
  plots[[i]] <- ggplot(subset(dt_ne, run==paste0("Run", para_run)), aes(x=num_target, y = Ne, fill = strength))+
    geom_boxplot()+
    geom_hline(yintercept = 311, linetype = "dashed")+
    scale_fill_manual(values = c("white","#D4EEFC","#FAECAF","#ECC4B5"))+
    facet_grid(~strength, scale = "free_x", space = "free_x")+
    labs(x="Number of Selection Targets", y="Effective Population Size (Ne)", title = paste0("Run",para_run))+
    theme(legend.position = "none",
          axis.text.x = element_text(angle = -60, vjust = 0.5, hjust = 0))
  i <- i + 1
}

merge_p <- ggarrange(plotlist = plots,
                     nrow=2, ncol = 5)
merge_p<-annotate_figure(
    merge_p,
    top = text_grob(
      paste0(simulation,"_",linkage,"_Ne"),
      color = "black", face = "bold", size = 20,
      x = 0, hjust = 0
    )
)
    #fig.lab = paste0(simulation,"_",linkage,"_Ne"), 
    #fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_Ne.pdf"), plot = merge_p, width = 30, height = 13)
rm(dt_ne)

```


#3. simulationB_LD
##initialize parameters
```{r}
##parameters that are constant across this section
workdir <- "04slim_simulationB_LD_shuffle_genotype"
simulation <- "SimulationB"
linkage <- "LD"
para_num_sample <- 400 
```



##3.1 PCA
```{r}
#organize by run
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10,50,100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength)
      i <- i + 1
    }
  }
  plots[[19]] <- pca_plot(dir = workdir, run = para_run, popsize = 300, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Drift300"))
  plots[[20]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Drift1250"))
  p_merge<-ggarrange(plotlist = plots, ncol = 6, nrow = 4, common.legend = T)
  p_merge<- annotate_figure(p_merge, fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_PCA"), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")

  ggsave(filename = paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_PCA.pdf"), plot = p_merge, width = 18, height = 12)
}
  

#organize plot by selection regime
#drift
for(para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
    plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = para_popsize, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Run",para_run))
    i=i+1
    }
  p_merge<-ggarrange(plotlist = plots, ncol = 5, nrow = 2, common.legend = T)
  p_merge<- annotate_figure(p_merge, fig.lab = paste0(simulation,"_",linkage,"_Drift_popsize",para_popsize), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(filename = paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_PCA.pdf"), plot = p_merge, width = 20, height = 9)
}

for (para_num_target in c(10,100,1000,5000,10000,20000)){
  for (para_strength in c(10,50,100)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength,plot_title = paste0("Run",para_run))
      i=i+1
    }
    p_merge<-ggarrange(plotlist = plots, ncol = 5, nrow = 2, common.legend = T)
    p_merge<- annotate_figure(p_merge, 
                              fig.lab = paste0(simulation,"_",linkage,"_",para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")_PCA"), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_PCA.pdf"), plot = p_merge, width = 20, height = 9)
  }
}
rm(p_merge, plots)
```

##3.2 AFC correlation_allSNPs
```{r}
#load AFC correlation
afc_cor<-NULL
##drift
para_num_target=10 #there's no selection target under neutral simulation, just to match the name
para_strength=0
for (para_popsize in c(300,1250)){
  for (para_run in seq(1,10)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_allSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample
    temp_f$Num_target <- para_num_target
    temp_f$Strength<- para_strength
    afc_cor<-rbind(afc_cor,temp_f)
  }
}

##selection
para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    for (para_strength in c(10,50,100)){
      temp_f<-fread(paste0("../",workdir,
                           "/03afc_cor/results_allSNPs/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,"_",
                           para_num_target,"loci_s",para_strength,
                           "_cor.txt.gz"))
      temp_f$Run <- para_run
      temp_f$Popsize <- para_popsize
      temp_f$Num_sample <- para_num_sample
      temp_f$Num_target <- para_num_target
      temp_f$Strength <- para_strength
      afc_cor<-rbind(afc_cor,temp_f)
    }
  }
}
      
afc_cor$gen<-factor(afc_cor$gen)

#plot
##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10, 50, 100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 plot_title = paste0(para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")"))
      i <- i + 1
    }
  }
  plots[[19]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = 300, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = "Drift300")
  plots[[20]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = 1250, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = "Drift1250")
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_allSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 18, height = 13)
}



##organize by selection regime
###drift
for (para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
  
  }
  combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_Drift",para_popsize,"_AFC_cor_allSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}
###selection
para_popsize <- 1250
for (para_strength in c(10,50, 100)){
  for (para_num_target in c(10, 100, 1000,5000,10000,20000)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
    }
    combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_", para_num_target, "loci_s",para_strength, "(sc = ", para_strength/para_num_target, ")_AFC_cor_allSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
  }
}


```


##3.3 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor <- afc_cor[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_strength in c(10,50,100)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    para_popsize <- 1250
    dt_plot <- summary_median_afc_cor[
      Popsize == para_popsize &
      Num_sample == para_num_sample &
      Num_target == para_num_target &
      Strength == para_strength
      ]
    plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
      geom_boxplot()+
      ylim(-0.1,1)+
      #stat_compare_means(aes(group=comparison), method = "wilcox.test", label = "p.signif", hide.ns = TRUE)+
    labs(title=paste0(para_num_target,"loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")"), 
         x = "Generation", y = "AFC correlation")
    i=i+1
  }
}
dt_plot <- summary_median_afc_cor[
      Popsize == 300 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[19]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.01,0.01)+
    #stat_compare_means(aes(group=comparison), method = "wilcox.test", label = "p.signif", hide.ns = TRUE)+
  labs(title="Drift300", x = "Generation", y = "AFC correlation")


dt_plot <- summary_median_afc_cor[
      Popsize == 1250 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[20]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.01,0.01)+
    #stat_compare_means(aes(group=comparison), method = "wilcox.test", label = "p.signif", hide.ns = TRUE)+
   labs(title="Drift1250", x = "Generation", y = "AFC correlation")

combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_allSNPs.pdf"),plot = combine_plot, width = 18, height = 13)
rm(afc_cor)
rm(summary_median_afc_cor)
```


##3.4 AFC correlation_PC1_sigSNPs
```{r}
#load AFC correlation
afc_cor_sig<-NULL
##drift
para_num_target=10 #there's no selection target under neutral simulation, just to match the name
para_strength=0
for (para_popsize in c(300,1250)){
  for (para_run in seq(1,10)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_PC1_sigSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample
    temp_f$Num_target <- para_num_target
    temp_f$Strength<- para_strength
    afc_cor_sig<-rbind(afc_cor_sig,temp_f)
  }
}

##selection
para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    for (para_strength in c(10,50,100)){
      temp_f<-fread(paste0("../",workdir,
                           "/03afc_cor/results_PC1_sigSNPs/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,"_",
                           para_num_target,"loci_s",para_strength,
                           "_cor.txt.gz"))
      temp_f$Run <- para_run
      temp_f$Popsize <- para_popsize
      temp_f$Num_sample <- para_num_sample
      temp_f$Num_target <- para_num_target
      temp_f$Strength <- para_strength
      afc_cor_sig<-rbind(afc_cor_sig,temp_f)
    }
  }
}
      
afc_cor_sig$gen<-factor(afc_cor_sig$gen)

#plot
##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10, 50, 100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength,
                                 ymin = -0.6, ymax = 1.0,
                                 plot_title = paste0(para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")"))
      i <- i + 1
    }
  }
  plots[[19]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = 300, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.6, ymax = 0.6,
                                 plot_title = "Drift300")
  plots[[20]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = 1250, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.6, ymax = 0.6,
                                 plot_title = "Drift1250")
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 18, height = 13)
}



##organize by selection regime
###drift
for (para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.6, ymax = 0.6,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
  
  }
  combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_Drift",para_popsize,"_AFC_cor_PC1_sigSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}
###selection
para_popsize <- 1250
for (para_strength in c(10,50, 100)){
  for (para_num_target in c(10, 100, 1000,5000,10000,20000)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 ymin = -0.6, ymax = 1.0,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
    }
    combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_", para_num_target, "loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")_AFC_cor_PC1_sigSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
  }
}


```

##3.5 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor_sig <- afc_cor_sig[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_strength in c(10,50,100)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    para_popsize <- 1250
    dt_plot <- summary_median_afc_cor_sig[
      Popsize == para_popsize &
      Num_sample == para_num_sample &
      Num_target == para_num_target &
      Strength == para_strength
      ]
    plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
      geom_boxplot()+
      ylim(-0.6,1)+
      #stat_compare_means(aes(group=comparison), method = "wilcox.test", label = "p.signif", hide.ns = TRUE)+
    labs(title=paste0(para_num_target,"loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")"),
         x = "Generation", y = "AFC correlation")
    i=i+1
  }
}
dt_plot <- summary_median_afc_cor_sig[
      Popsize == 300 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[19]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.03,0.04)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
  labs(title="Drift300", x = "Generation", y = "AFC correlation")


dt_plot <- summary_median_afc_cor_sig[
      Popsize == 1250 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[20]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.03,0.04)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
   labs(title="Drift1250", x = "Generation", y = "AFC correlation")

combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_PC1_sigSNPs.pdf"),plot = combine_plot, width = 18, height = 13)
rm(afc_cor_sig)
rm(summary_median_afc_cor_sig)
```

##3.6 Effective population size(Ne)
```{r}

dt_ne <- data.table()
#load data
##drift
for (para_run in seq(1,10)){
  for (para_popsize in c(300,1250)){
    for (para_num_sample in c(400)){
      for (para_num_target in c(10)){
        for (para_strength in c(0)){
          f_name <- paste0("../",workdir, "/04estimate_Ne/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,
                           "_",para_num_target,"loci_s",para_strength,
                           ".ne")
          temp_ne <- fread(f_name)
          temp_ne[, c("run", "popsize", "num_sample", "num_target", "strength") := 
                    lapply(
                      tstrsplit(treatment, split = "_", fill = NA), 
                      factor)]
          temp_ne[, num_target := paste0("Drift", para_popsize)]
          temp_ne[, strength := "Neutral"]
          dt_ne <- rbind(dt_ne, temp_ne)
        }
      }
    }
  }
}
##selection
for (para_run in seq(1,10)){
  for (para_popsize in c(1250)){
    for (para_num_sample in c(400)){
      for (para_num_target in c(10, 100, 1000, 5000, 10000, 20000)){
        for (para_strength in c(10, 50, 100)){
      f_name <- paste0("../",workdir, "/04estimate_Ne/Run",para_run,
                       "_popsize",para_popsize,
                       "_n",para_num_sample,
                       "_",para_num_target,"loci_s",para_strength,
                       ".ne")
      temp_ne <- fread(f_name)
      temp_ne[, c("run", "popsize", "num_sample", "num_target", "strength") := 
                lapply(
                  tstrsplit(treatment, split = "_", fill = NA),
                  factor)]
      dt_ne <- rbind(dt_ne, temp_ne)
        }
      }
    }
  }
}

dt_ne[, num_target := factor(num_target, levels = c("Drift300","Drift1250",
                                                    "10loci", "100loci", "1000loci", "5000loci", "10000loci", "20000loci"))]
#plot
plots <- list()
i <- 1
for (para_run in seq(1,10)){
  plots[[i]] <- ggplot(subset(dt_ne, run==paste0("Run", para_run)), aes(x=num_target, y = Ne, fill = strength))+
    geom_boxplot()+
    geom_hline(yintercept = 311, linetype = "dashed")+
    scale_fill_manual(values = c("white","#D4EEFC","#FAECAF","#ECC4B5"))+
    facet_grid(~strength, scale = "free_x", space = "free_x")+
    labs(x="Number of Selection Targets", y="Effective Population Size (Ne)", title = paste0("Run",para_run))+
    theme(legend.position = "none",
          axis.text.x = element_text(angle = -60, vjust = 0.5, hjust = 0))
  i <- i + 1
}

merge_p <- ggarrange(plotlist = plots,
                     nrow=2, ncol = 5)
merge_p<-annotate_figure(
    merge_p,
    top = text_grob(
      paste0(simulation,"_",linkage,"_Ne"),
      color = "black", face = "bold", size = 20,
      x = 0, hjust = 0
    )
)
    #fig.lab = paste0(simulation,"_",linkage,"_Ne"), 
    #fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_Ne.pdf"), plot = merge_p, width = 30, height = 13)
rm(dt_ne)
```



#4. simulationB_LE
##initialize parameters
```{r}
##parameters that are constant across this section
workdir <- "05slim_simulationB_LE_shuffle_genotype"
simulation <- "SimulationB"
linkage <- "LE"
para_num_sample <- 400 
```



##4.1 PCA
```{r}
#organize by run
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10,50,100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength)
      i <- i + 1
    }
  }
  plots[[19]] <- pca_plot(dir = workdir, run = para_run, popsize = 300, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Drift300"))
  plots[[20]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Drift1250"))
  p_merge<-ggarrange(plotlist = plots, ncol = 6, nrow = 4, common.legend = T)
  p_merge<- annotate_figure(p_merge, fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_PCA"), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")

  ggsave(filename = paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_PCA.pdf"), plot = p_merge, width = 18, height = 12)
}
  

#organize plot by selection regime
#drift
for(para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
    plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = para_popsize, num_sample = para_num_sample, num_target = 10, strength = 0, plot_title = paste0("Run",para_run))
    i=i+1
    }
  p_merge<-ggarrange(plotlist = plots, ncol = 5, nrow = 2, common.legend = T)
  p_merge<- annotate_figure(p_merge, fig.lab = paste0(simulation,"_",linkage,"_Drift_popsize",para_popsize), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(filename = paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_PCA.pdf"), plot = p_merge, width = 20, height = 9)
}

for (para_num_target in c(10,100,1000,5000,10000,20000)){
  for (para_strength in c(10,50,100)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength,plot_title = paste0("Run",para_run))
      i=i+1
    }
    p_merge<-ggarrange(plotlist = plots, ncol = 5, nrow = 2, common.legend = T)
    p_merge<- annotate_figure(p_merge, 
                              fig.lab = paste0(simulation,"_",linkage,"_",para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")_PCA"), fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_PCA.pdf"), plot = p_merge, width = 20, height = 9)
  }
}
rm(p_merge, plots)
```

##4.2 AFC correlation_allSNPs
```{r}
#load AFC correlation
afc_cor<-NULL
##drift
para_num_target=10 #there's no selection target under neutral simulation, just to match the name
para_strength=0
for (para_popsize in c(300,1250)){
  for (para_run in seq(1,10)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_allSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample
    temp_f$Num_target <- para_num_target
    temp_f$Strength<- para_strength
    afc_cor<-rbind(afc_cor,temp_f)
  }
}

##selection
para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    for (para_strength in c(10,50,100)){
      temp_f<-fread(paste0("../",workdir,
                           "/03afc_cor/results_allSNPs/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,"_",
                           para_num_target,"loci_s",para_strength,
                           "_cor.txt.gz"))
      temp_f$Run <- para_run
      temp_f$Popsize <- para_popsize
      temp_f$Num_sample <- para_num_sample
      temp_f$Num_target <- para_num_target
      temp_f$Strength <- para_strength
      afc_cor<-rbind(afc_cor,temp_f)
    }
  }
}
      
afc_cor$gen<-factor(afc_cor$gen)

#plot
##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10, 50, 100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 plot_title = paste0(para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")"))
      i <- i + 1
    }
  }
  plots[[19]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = 300, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = "Drift300")
  plots[[20]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = 1250, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = "Drift1250")
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_allSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 18, height = 13)
}



##organize by selection regime
###drift
for (para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.05, ymax = 0.08,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
  
  }
  combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_Drift",para_popsize,"_AFC_cor_allSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}
###selection
para_popsize <- 1250
for (para_strength in c(10,50, 100)){
  for (para_num_target in c(10, 100, 1000,5000,10000,20000)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
    }
    combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_", para_num_target, "loci_s",para_strength, "(sc = ", para_strength/para_num_target, ")_AFC_cor_allSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
  }
}


```


##4.3 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor <- afc_cor[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_strength in c(10,50,100)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    para_popsize <- 1250
    dt_plot <- summary_median_afc_cor[
      Popsize == para_popsize &
      Num_sample == para_num_sample &
      Num_target == para_num_target &
      Strength == para_strength
      ]
    plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
      geom_boxplot()+
      ylim(-0.1,1)+
      #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
    labs(title=paste0(para_num_target,"loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")"),
         x= "Generation", y = "AFC correlation")
    i=i+1
  }
}
dt_plot <- summary_median_afc_cor[
      Popsize == 300 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[19]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.01,0.01)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
  labs(title="Drift300", x = "Generation", y = "AFC correlation")


dt_plot <- summary_median_afc_cor[
      Popsize == 1250 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[20]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.01,0.01)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
   labs(title="Drift1250", x = "Generation", y = "AFC correlation")

combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_allSNPs.pdf"),plot = combine_plot, width = 18, height = 13)
rm(afc_cor)
rm(summary_median_afc_cor)
```


##4.4 AFC correlation_PC1_sigSNPs
```{r}
#load AFC correlation
afc_cor_sig<-NULL
##drift
para_num_target=10 #there's no selection target under neutral simulation, just to match the name
para_strength=0
for (para_popsize in c(300,1250)){
  for (para_run in seq(1,10)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_PC1_sigSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample
    temp_f$Num_target <- para_num_target
    temp_f$Strength<- para_strength
    afc_cor_sig<-rbind(afc_cor_sig,temp_f)
  }
}

##selection
para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    for (para_strength in c(10,50,100)){
      temp_f<-fread(paste0("../",workdir,
                           "/03afc_cor/results_PC1_sigSNPs/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,"_",
                           para_num_target,"loci_s",para_strength,
                           "_cor.txt.gz"))
      temp_f$Run <- para_run
      temp_f$Popsize <- para_popsize
      temp_f$Num_sample <- para_num_sample
      temp_f$Num_target <- para_num_target
      temp_f$Strength <- para_strength
      afc_cor_sig<-rbind(afc_cor_sig,temp_f)
    }
  }
}
      
afc_cor_sig$gen<-factor(afc_cor_sig$gen)

#plot
##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_strength in c(10, 50, 100)){
    for (para_num_target in c(10,100,1000,5000,10000,20000)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength,
                                 ymin = -0.6, ymax = 1.0,
                                 plot_title = paste0(para_num_target,"loci_s",para_strength," (sc = ",para_strength/para_num_target,")"))
      i <- i + 1
    }
  }
  plots[[19]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = 300, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.6, ymax = 0.6,
                                 plot_title = "Drift300")
  plots[[20]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = 1250, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.6, ymax = 0.6,
                                 plot_title = "Drift1250")
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 18, height = 13)
}



##organize by selection regime
###drift
for (para_popsize in c(300,1250)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = 10, 
                                 strength = 0, 
                                 ymin = -0.6, ymax = 0.6,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
  
  }
  combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_Drift",para_popsize,"_AFC_cor_PC1_sigSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_Drift",para_popsize,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}
###selection
para_popsize <- 1250
for (para_strength in c(10,50, 100)){
  for (para_num_target in c(10, 100, 1000,5000,10000,20000)){
    plots <- list()
    i <- 1
    for (para_run in seq(1,10)){
      plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                                 run = para_run, 
                                 popsize = para_popsize, 
                                 num_sample = para_num_sample, 
                                 num_target = para_num_target, 
                                 strength = para_strength, 
                                 ymin = -0.6, ymax = 1.0,
                                 plot_title = paste0("Run",para_run))
      i <- i + 1
    }
    combine_plot <- ggarrange(
      plotlist = plots,
      ncol = 5, nrow = 2, common.legend = TRUE
      )
    combine_plot<-annotate_figure(
      combine_plot,
      fig.lab = paste0(simulation,"_",linkage, "_", para_num_target, "loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")_AFC_cor_PC1_sigSNPs"), 
      fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_",para_num_target,"loci_s",para_strength,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
  }
}


```

##4.5 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor_sig <- afc_cor_sig[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_strength in c(10,50,100)){
  for (para_num_target in c(10,100,1000,5000,10000,20000)){
    para_popsize <- 1250
    dt_plot <- summary_median_afc_cor_sig[
      Popsize == para_popsize &
      Num_sample == para_num_sample &
      Num_target == para_num_target &
      Strength == para_strength
      ]
    plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
      geom_boxplot()+
      ylim(-0.6,1)+
      #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
      labs(title=paste0(para_num_target,"loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")"),
           x = "Generation", y = "AFC correlation")
    i=i+1
  }
}
dt_plot <- summary_median_afc_cor_sig[
      Popsize == 300 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[19]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.1,0.1)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
  labs(title="Drift300", x = "Generation", y = "AFC correlation")


dt_plot <- summary_median_afc_cor_sig[
      Popsize == 1250 &
      Num_sample == para_num_sample &
      Num_target == 10 &
      Strength == 0
      ]
plots[[20]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.1,0.1)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
   labs(title="Drift1250", x = "Generation", y = "AFC correlation")

combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 6, nrow = 4, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_PC1_sigSNPs.pdf"),plot = combine_plot, width = 18, height = 13)
rm(afc_cor_sig)
rm(summary_median_afc_cor_sig)
```

##4.6 Effective population size(Ne)
```{r}

dt_ne <- data.table()
#load data
##drift
for (para_run in seq(1,10)){
  for (para_popsize in c(300,1250)){
    for (para_num_sample in c(400)){
      for (para_num_target in c(10)){
        for (para_strength in c(0)){
          f_name <- paste0("../",workdir, "/04estimate_Ne/Run",para_run,
                           "_popsize",para_popsize,
                           "_n",para_num_sample,
                           "_",para_num_target,"loci_s",para_strength,
                           ".ne")
          temp_ne <- fread(f_name)
          temp_ne[, c("run", "popsize", "num_sample", "num_target", "strength") := 
                    lapply(
                      tstrsplit(treatment, split = "_", fill = NA), 
                      factor)]
          temp_ne[, num_target := paste0("Drift", para_popsize)]
          temp_ne[, strength := "Neutral"]
          dt_ne <- rbind(dt_ne, temp_ne)
        }
      }
    }
  }
}
##selection
for (para_run in seq(1,10)){
  for (para_popsize in c(1250)){
    for (para_num_sample in c(400)){
      for (para_num_target in c(10, 100, 1000, 5000, 10000, 20000)){
        for (para_strength in c(10, 50, 100)){
      f_name <- paste0("../",workdir, "/04estimate_Ne/Run",para_run,
                       "_popsize",para_popsize,
                       "_n",para_num_sample,
                       "_",para_num_target,"loci_s",para_strength,
                       ".ne")
      temp_ne <- fread(f_name)
      temp_ne[, c("run", "popsize", "num_sample", "num_target", "strength") := 
                lapply(
                  tstrsplit(treatment, split = "_", fill = NA),
                  factor)]
      dt_ne <- rbind(dt_ne, temp_ne)
        }
      }
    }
  }
}

dt_ne[, num_target := factor(num_target, levels = c("Drift300","Drift1250",
                                                    "10loci", "100loci", "1000loci", "5000loci", "10000loci", "20000loci"))]
#plot
plots <- list()
i <- 1
for (para_run in seq(1,10)){
  plots[[i]] <- ggplot(subset(dt_ne, run==paste0("Run", para_run)), aes(x=num_target, y = Ne, fill = strength))+
    geom_boxplot()+
    geom_hline(yintercept = 311, linetype = "dashed")+
    scale_fill_manual(values = c("white","#D4EEFC","#FAECAF","#ECC4B5"))+
    facet_grid(~strength, scale = "free_x", space = "free_x")+
    labs(x="Number of Selection Targets", y="Effective Population Size (Ne)", title = paste0("Run",para_run))+
    theme(legend.position = "none",
          axis.text.x = element_text(angle = -60, vjust = 0.5, hjust = 0))
  i <- i + 1
}

merge_p <- ggarrange(plotlist = plots,
                     nrow=2, ncol = 5)
merge_p<-annotate_figure(
    merge_p,
    top = text_grob(
      paste0(simulation,"_",linkage,"_Ne"),
      color = "black", face = "bold", size = 20,
      x = 0, hjust = 0
    )
)
    #fig.lab = paste0(simulation,"_",linkage,"_Ne"), 
    #fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_Ne.pdf"), plot = merge_p, width = 30, height = 13)
rm(dt_ne)

```


#5. simulationC_LD
##initialize parameters
```{r}
##parameters that are constant across this section
workdir <- "06slim_simulationC_LD_samplesize"
simulation <- "SimulationC"
linkage <- "LD"
para_num_target <- 100 
para_strength <- 10
```


##5.1 PCA
```{r}
#organize by run
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_num_sample in c(400,800,1200,2500)){
    plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength, plot_title = paste0("n",para_num_sample))
      i <- i + 1
      }
  p_merge<-ggarrange(plotlist = plots, ncol = 4, nrow = 1, common.legend = T)
  p_merge<- annotate_figure(p_merge, fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_PCA"), fig.lab.pos = "top.left", fig.lab.size = 15, fig.lab.face = "bold")

  ggsave(filename = paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_PCA.pdf"), plot = p_merge, width = 12, height = 4)
}
  

#organize plot by selection regime


for (para_num_sample in c(400,800,1200,2500)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
    plots[[i]] <- pca_plot(dir = workdir, run = para_run, popsize = 1250, num_sample = para_num_sample, num_target = para_num_target, strength = para_strength,plot_title = paste0("Run",para_run))
    i=i+1
    }
  p_merge<-ggarrange(plotlist = plots, ncol = 5, nrow = 2, common.legend = T)
  p_merge<- annotate_figure(p_merge, 
                            fig.lab = paste0(simulation,"_",linkage,"_n",para_num_sample,"_PCA"), 
                            fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/by_regime/",linkage,"_n",para_num_sample,"_PCA.pdf"), plot = p_merge, width = 20, height = 9)
  
}
rm(p_merge, plots)
```

##5.2 AFC correlation_allSNPs
```{r}
#load AFC correlation
afc_cor<-NULL

para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_sample in c(400,800,1200,2500)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_allSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample
    temp_f$Num_target <- para_num_target
    temp_f$Strength <- para_strength
    afc_cor<-rbind(afc_cor,temp_f)
  }
}
afc_cor$gen<-factor(afc_cor$gen)

#plot
##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_num_sample in c(400, 800, 1200, 2500)){
    plots[[i]] <- afc_cor_plot(afc_cor, 
                               run = para_run, 
                               popsize = para_popsize, 
                               num_sample = para_num_sample, 
                               num_target = para_num_target, 
                               strength = para_strength, 
                               plot_title = paste0("n", para_num_sample))
    i <- i + 1
  }
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 4, nrow = 1, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_allSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 12, height = 4)
}



##organize by selection regime

###selection
para_popsize <- 1250
for (para_num_sample in c(400, 800, 1200, 2500)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
    plots[[i]] <- afc_cor_plot(afc_cor, 
                               run = para_run, 
                               popsize = para_popsize, 
                               num_sample = para_num_sample, 
                               num_target = para_num_target, 
                               strength = para_strength, 
                               plot_title = paste0("Run",para_run))
    i <- i + 1
    }
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 5, nrow = 2, common.legend = TRUE)
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage, "_n", para_num_sample,"_AFC_cor_allSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_n",para_num_sample,"_AFC_cor_allSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}


```


##5.3 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor <- afc_cor[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_num_sample in c(400, 800, 1200, 2500)){
    para_popsize <- 1250
    dt_plot <- summary_median_afc_cor[
      Popsize == para_popsize &
      Num_sample == para_num_sample &
      Num_target == para_num_target &
      Strength == para_strength
      ]
    plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
      geom_boxplot()+
      ylim(-0.1,1)+
      #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
    labs(title=paste0("n",para_num_sample),
         x= "Generation", y = "AFC correlation")
    i=i+1
  }



combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 4, nrow = 1, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor_allSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 15, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_allSNPs.pdf"),plot = combine_plot, width = 15, height = 5)
rm(afc_cor)
rm(summary_median_afc_cor)
```


##5.4 AFC correlation_PC1_sigSNPs
```{r}
#load AFC correlation
afc_cor_sig<-NULL
##selection
para_popsize <- 1250
for (para_run in seq(1,10)){
  for (para_num_sample in c(400, 800, 1200, 2500)){
    temp_f<-fread(paste0("../",workdir,
                         "/03afc_cor/results_PC1_sigSNPs/Run",para_run,
                         "_popsize",para_popsize,
                         "_n",para_num_sample,"_",
                         para_num_target,"loci_s",para_strength,
                         "_cor.txt.gz"))
    temp_f$Run <- para_run
    temp_f$Popsize <- para_popsize
    temp_f$Num_sample <- para_num_sample      
    temp_f$Num_target <- para_num_target
    temp_f$Strength <- para_strength
    afc_cor_sig<-rbind(afc_cor_sig,temp_f)
  }
}
      
afc_cor_sig$gen<-factor(afc_cor_sig$gen)

#plot
##organize by run
plots <- list()
for (para_run in seq(1,10)){
  plots <- list()
  i <- 1
  for (para_num_sample in c(400,800,1200,2500)){
    plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                               run = para_run, 
                               popsize = para_popsize, 
                               num_sample = para_num_sample, 
                               num_target = para_num_target, 
                               strength = para_strength,
                               ymin = -0.6, ymax = 1.0,
                               plot_title = paste0("n",para_num_sample))
    i <- i + 1
  }
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 4, nrow = 1, common.legend = TRUE
  )
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 15, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_run/",linkage,"_Run",para_run,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 5)
}



##organize by selection regime
###selection
para_popsize <- 1250
for (para_num_sample in c(400, 800, 1200, 2500)){
  plots <- list()
  i <- 1
  for (para_run in seq(1,10)){
    plots[[i]] <- afc_cor_plot(afc_cor_sig, 
                               run = para_run, 
                               popsize = para_popsize, 
                               num_sample = para_num_sample, 
                               num_target = para_num_target, 
                               strength = para_strength, 
                               ymin = -0.6, ymax = 1.0,
                               plot_title = paste0("Run",para_run))
    i <- i + 1
  }
  combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 5, nrow = 2, common.legend = TRUE)
  combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage, "_n", para_num_sample,"_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 12, fig.lab.face = "bold")
  ggsave(paste0(simulation,"/by_regime/",linkage,"_n",para_num_sample,"_AFC_cor_PC1_sigSNPs.pdf"), plot=combine_plot, width = 15, height = 7)
}



```

##5.5 median AFC correlation across runs_allSNPs
```{r}
#this is to summarize results across simulation runs
#within each run, the median AFC correlation were obtained for each parameter combination & comparison(between and within supergroup)
#then those median values were used to plot the boxplot across simulation runs
summary_median_afc_cor_sig <- afc_cor_sig[, .(median_afc_cor = median(r)), by = .(gen, comparison, Run, Popsize, Num_sample, Num_target, Strength)]
plots <- list()
i <- 1
for (para_num_sample in c(400,800,1200,2500)){
  para_popsize <- 1250
  dt_plot <- summary_median_afc_cor_sig[
    Popsize == para_popsize &
    Num_sample == para_num_sample &
    Num_target == para_num_target &
    Strength == para_strength
    ]
  plots[[i]] <- ggplot(dt_plot, aes(x=gen, y=median_afc_cor, fill=comparison))+
    geom_boxplot()+
    ylim(-0.6,1)+
    #stat_compare_means(aes(group=comparison),method = "wilcox.test",label = "p.signif",hide.ns = TRUE)+
    labs(title=paste0(para_num_target,"loci_s",para_strength, " (sc = ", para_strength/para_num_target, ")"),
         x = "Generation", y = "AFC correlation")
  i=i+1
}


combine_plot <- ggarrange(
    plotlist = plots,
    ncol = 4, nrow = 1, common.legend = TRUE
  )
combine_plot<-annotate_figure(
    combine_plot,
    fig.lab = paste0(simulation,"_",linkage,"_median_AFC_cor_PC1_sigSNPs"), 
    fig.lab.pos = "top.left", fig.lab.size = 15, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_median_AFC_cor_PC1_sigSNPs.pdf"),plot = combine_plot, width = 15, height = 5)
rm(afc_cor_sig)
rm(summary_median_afc_cor_sig)
```

##5.6 Effective population size(Ne)
```{r}

dt_ne <- data.table()
#load data

##selection
for (para_run in seq(1,10)){
  for (para_popsize in c(1250)){
    for (para_num_sample in c(400,800,1200,2500)){
      f_name <- paste0("../",workdir, "/04estimate_Ne/Run",para_run,
                       "_popsize",para_popsize,
                       "_n",para_num_sample,
                       "_",para_num_target,"loci_s",para_strength,
                       ".ne")
      temp_ne <- fread(f_name)
      temp_ne[, c("run", "popsize", "num_sample", "num_target", "strength") := 
                lapply(
                  tstrsplit(treatment, split = "_", fill = NA),
                  factor)]
      dt_ne <- rbind(dt_ne, temp_ne)
    }
  }
}

dt_ne[, num_target := factor(num_target, levels = c("Drift300","Drift1250",
                                                    "10loci", "100loci", "1000loci", "5000loci", "10000loci", "20000loci"))]
#plot
plots <- list()
i <- 1
for (para_run in seq(1,10)){
  plots[[i]] <- ggplot(subset(dt_ne, run==paste0("Run", para_run)), aes(x=num_target, y = Ne, fill = strength))+
    geom_boxplot()+
    geom_hline(yintercept = 311, linetype = "dashed")+
    scale_fill_manual(values = c("#D4EEFC"))+
    facet_grid(~strength, scale = "free_x", space = "free_x")+
    labs(x="Number of Selection Targets", y="Effective Population Size (Ne)", title = paste0("Run",para_run))+
    theme(legend.position = "none",
          axis.text.x = element_text(angle = -60, vjust = 0.5, hjust = 0))
  i <- i + 1
}

merge_p <- ggarrange(plotlist = plots,
                     nrow=2, ncol = 5)
merge_p<-annotate_figure(
    merge_p,
    top = text_grob(
      paste0(simulation,"_",linkage,"_Ne"),
      color = "black", face = "bold", size = 20,
      x = 0, hjust = 0
    )
)
    #fig.lab = paste0(simulation,"_",linkage,"_Ne"), 
    #fig.lab.pos = "top.left", fig.lab.size = 20, fig.lab.face = "bold")
ggsave(filename = paste0(simulation,"/",linkage,"_Ne.pdf"), plot = merge_p, width = 30, height = 13)
rm(dt_ne)

```












